{"version":3,"file":"timeously.js","sourceRoot":"","sources":["../src/timeously.ts"],"names":[],"mappings":"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","sourcesContent":["import { INTERVAL_TYPE } from './intervaltype';\nimport { TimeBucket } from './timebucket';\nimport { TimeSpan } from './timespan';\n\ninterface IIntervalLimit {\n\t[key: string]: number;\n\tmillisecond: number;\n\tsecond: number;\n\tminute: number;\n\thour: number;\n\tmonth: number;\n}\n\nconst intervals = ['year', 'month', 'day', 'hour', 'minute', 'second', 'millisecond'];\nconst intervalLimit: IIntervalLimit = {\n\tmillisecond: 1000,\n\tsecond: 60,\n\tminute: 60,\n\thour: 24,\n\tmonth: 12\n};\n\nfunction getLimit(intervalType: INTERVAL_TYPE, timeBucket: TimeBucket) {\n\tif (intervalType === 'day') {\n\t\treturn timeBucket.daysInMonth;\n\t}\n\telse {\n\t\tconst limit = intervalLimit[intervalType];\n\t\tif (!limit) {\n\t\t\tthrow new Error(`Can not currently handle ${intervalType} intervals`);\n\t\t}\n\t\treturn limit;\n\t}\n}\n\nfunction validTime(currTime: number, startTime: number, stopTime: number) {\n\tif (!startTime || !stopTime)\n\t\treturn true;\n\n\tif (startTime < stopTime)\n\t\treturn currTime >= startTime && currTime <= stopTime;\n\n\treturn currTime >= startTime || currTime <= stopTime;\n}\n\nexport interface ITimeouslyOptions {\n\tname: string;\n\tinterval: number;\n\ttype: INTERVAL_TYPE;\n\ttz: string;\n\tstart: number;\n\tstop: number;\n}\n\nexport class Timeously {\n\tprivate name: string;\n\tprivate interval: number;\n\tprivate intervalType: INTERVAL_TYPE;\n\tprivate tz: string;\n\tprivate callback: () => void;\n\tprivate startTime: number;\n\tprivate stopTime: number;\n\tprivate started = false;\n\tprivate timerID: NodeJS.Timer = null;\n\n\tconstructor(options: ITimeouslyOptions, callback: () => void) {\n\t\tconst { name, interval, type, tz, start, stop } = options;\n\n\t\tthis.name = (name ? ` ${ name }` : '');\n\t\tthis.interval = interval || 1;\n\t\tthis.intervalType = type || INTERVAL_TYPE.MINUTELY;\n\t\tthis.tz = tz;\n\t\tthis.callback = callback;\n\t\tthis.startTime = start;\n\t\tthis.stopTime = stop;\n\n\t\tthis.start();\n\t}\n\n\tprivate get title() {\n\t\tconst { interval, intervalType } = this;\n\n\t\tfor (const key in INTERVAL_TYPE) {\n\t\t  if (INTERVAL_TYPE.hasOwnProperty(key)) {\n\t\t\t  const val = INTERVAL_TYPE[key];\n\n\t\t\t  if (val === intervalType)\n\t\t\t\t  return `${ interval } ${ key.toLowerCase() }`;\n\t\t  }\n\t\t}\n\t}\n\n\tprivate get now(): TimeBucket {\n\t\treturn new TimeBucket().tz(this.tz);\n\t}\n\n\tpublic start() {\n\t\tconst { title, name } = this;\n\n\t\tconst nextTimeoutMillisec = this.calculateNextTimeout();\n\t\tconst timespan = new TimeSpan(nextTimeoutMillisec);\n\n//self.timerID = setTimeout(function () {\n//  self.execute();\n//}, nextTimeoutMillisec);\n\t\tthis.setLongTimeout(nextTimeoutMillisec);\n\n\t\tconsole.log(`Timeously starting ${ title }${ name } in T - ${ timespan.toString() } and counting`);\n\t}\n\n\tpublic stop() {\n\t\tconst { title, name, now } = this;\n\n\t\tconsole.log(`[${ title }]${name}: Called stop at ${now.toString()}`);\n\n\t\tthis.started = false;\n\t\tif (this.timerID !== null) {\n\t\t\tclearTimeout(this.timerID);\n\t\t\tthis.timerID = null;\n\t\t}\n\t}\n\n\tprivate execute() {\n\t\tif (!this.timerID) return;\n\n\t\tthis.callback();\n\n\t\tconst nextTimeoutMillisec = this.calculateNextTimeout();\n\n//self.timerID = setTimeout(function () {\n//  self.execute();\n//}, nextTimeoutMillisec);\n\t\tthis.setLongTimeout(nextTimeoutMillisec);\n\t}\n\n\tprivate calculateNextTimeout() {\n\t\tconst { name, title, interval, intervalType, started, now, startTime, stopTime } = this;\n\t\tconst limit = getLimit(intervalType, now);\n\t\tconst nextEvent = now;\n\n// set lower interval types to 0\n\t\tfor (let i = 6; i >= 0; i--) {\n\t\t\tconst interv = intervals[i];\n\t\t\tif (interv === intervalType) break;\n\n\t\t\tswitch (interv) {\n\t\t\t\tcase 'day':\n\t\t\t\t\tnextEvent[interv] = 1;\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'month':\n\t\t\t\t\tnextEvent[interv] = 0;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tnextEvent[interv] -= nextEvent[interv];\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t}\n\n// next possible interval\n\t\tnextEvent[intervalType]++;\n// current interval value\n\t\tlet currTime = nextEvent[intervalType];\n\n\t\tif (startTime) {\n\t\t\tif (!started) {\n\t\t\t\tthis.started = true;\n\t\t\t\tnextEvent[intervalType] += currTime > startTime ? limit - currTime + startTime : startTime - currTime;\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnextEvent[intervalType] += interval - 1;\n\n\t\t\t\tif (stopTime) {\n\t\t\t\t\tcurrTime = nextEvent[intervalType];\n\n\t\t\t\t\tif (!validTime(currTime, startTime, stopTime)) {\n\t\t\t\t\t\tnextEvent[intervalType] += currTime > startTime ? limit - currTime + startTime : startTime - currTime;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tif (!started) {\n\t\t\t\tthis.started = true;\n// get the next interval type event\n\t\t\t\twhile (interval > 1 && nextEvent[intervalType] % interval !== 0) {\n\t\t\t\t\tnextEvent[intervalType]++;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tnextEvent[intervalType] += interval - 1;\n\t\t\t}\n\t\t}\n\n// get the diff in milliseconds between nextEvent and now\n\t\tconst millisec = nextEvent.valueOf() - this.now.valueOf();\n\n\t\tconsole.log(`[${ this.now.toString() }] (${ title })${ name } - Next event is at ${ nextEvent.toString() }. ${ millisec }ms`);\n\n\t\treturn millisec;\n\t}\n\n\tprivate setLongTimeout(timeoutMs: number) {\n\t\tconst { title, name } = this;\n\t\tconst max = 86400000; // 1 day vs 2147483647 (max int)\n//if we have to wait more than max time, need to recursively call this function again\n\t\tif (timeoutMs > max) {\n//now wait until the max wait time passes then call this function again with\n//requested wait - max wait we just did, make sure and pass callback\n\t\t\tthis.timerID = setTimeout(() => {\n\t\t\t\tconst remaining = timeoutMs - max;\n\t\t\t\tconst days = Math.floor(remaining / 86400000);\n\t\t\t\tconsole.log(`${ title }${ name }: Long timer - ${ days } days remaining`);\n\t\t\t\tthis.setLongTimeout(remaining);\n\t\t\t}, max);\n\t\t}\n//if we are asking to wait less than max, finally just do regular seTimeout and call callback\n\t\telse {\n\t\t\tthis.timerID = setTimeout(() => this.execute(), timeoutMs);\n\t\t}\n\t}\n}\n"]}